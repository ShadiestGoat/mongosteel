var u=class extends Error{constructor(e){super("This document is not valid!");Object.setPrototypeOf(this,u.prototype),this.obj=e}},f=class{constructor(e){function o(n){if(typeof n=="string")return n||="string",{type:n,required:!0};if(Array.isArray(n))return n.length==2?{type:["string",o(n[1])],required:!0}:{type:[o(n[0])],required:!0};if(typeof n!="object")throw new Error("Unrecognised schema type!");return Object.keys(n).includes("type")&&Object.keys(n).includes("required")?(typeof n.type=="object"&&(n.type=o(n.type)),n):r(n)}function r(n){let d={};if(Array.isArray(n))throw new Error("Schema can't be an array!");if(typeof n!="object")throw new Error("Unrecognised schema type!");return Object.keys(n).forEach(i=>{d[i]=o(n[i])}),d}this.schema=r(e)}validate(e,o={}){if(typeof e!="object"||Array.isArray(e))return{valid:!1,reason:"majorBadType"};function r(i,a,t){switch(i.type){case"boolean":return typeof a!="boolean"?{valid:!1,reason:"badType",badKey:t}:!1;case"number":return typeof a!="number"?{valid:!1,reason:"badType",badKey:t}:!1;case"string":return typeof a!="string"?{valid:!1,reason:"badType",badKey:t}:i.pattern&&!i.pattern?.test(a)?{valid:!1,reason:"badType",badKey:t}:!1;case"mixed":return!1;default:return!1}}let n="";function d(i,a){if(Object.keys(i).includes("type")&&Object.keys(i).includes("required")){let t=r(i,a,n);if(t)return t}else for(let t in i)if(typeof a=="object"&&!Array.isArray(a)&&!Object.keys(a).includes(t)){if(i[t].required&&!o.ignoreRequired)return{valid:!1,reason:"required",badKey:t};i[t].default&&!o.ignoreDefault&&(typeof i[t].default=="function"?e[t]=i[t].default():e[t]=i[t].default)}else if(Array.isArray(i[t].type)){if(i[t].type.length==2){if(Array.isArray(a[t]))return{valid:!1,reason:"badType",badKey:t};for(let c in a[t]){let p=d(i[t].type[1],a[t][c]);if(!p.valid)return p}}if(!Array.isArray(a[t]))return{valid:!1,reason:"badType",badKey:t};n=t,a[t].forEach(c=>{let p=d(i[t].type[0],c);if(!p.valid)return p})}else if(typeof i[t].type=="object"){let c=d(i[t].type,a[t]);if(!c.valid)return c}else{let c=r(i[t],a[t],t);if(c)return c}return{valid:!0,res:e}}return d(this.schema,e)}};import{MongoClient as m}from"mongodb";function h(l){return["dbName","location","password","user"].forEach(e=>{if(!Object.keys(l).includes(e))throw Error(`${e} is required in the options!`)}),l.dbOpts||={},encodeURI(`mongodb://${l.user}:${l.password}@${l.location}/${l.dbName}${Object.keys(l.dbOpts).length==0?"":"?"}${Object.keys(l.dbOpts).map((e,o)=>`${o==0?"":"&"}${`${e}=${l.dbOpts[e]}`}`).join("")}`)}var s={on:!1,models:{},opts:{}},y=class{static async connect(e,o,r){if(s.on){if(e)throw new Error(`I already have a connection to ${s.url}!`);return s.db}if(!e)throw new Error("I have nothing to connect to!");let n=typeof e=="string"?encodeURI(e):h(e),d=await m.connect(n,Object.assign({useNewUrlParser:!0,useUnifiedTopology:!0},o)),i=d.db(),a=Object.assign({},r);return s={on:!0,db:i,client:d,url:n,opts:a,models:s.models},i}static async disconnect(){s&&(await s.client?.close(),s={on:!1,client:void 0,db:void 0,url:void 0,models:s.models,opts:s.opts})}};var g=class{constructor(e,o,r,n){let d=o.validate(r);if(!d.valid&&!s.opts.noVerification)throw new u(d);this.doc=d.valid?d.res:r,this.schema=o,this.saved=!1,this.oldId="",this.methods=n;let i=setInterval(function(){s.on&&(clearInterval(i),this.collection=s.db.collection(e))},100)}async save(){if(!s.opts.noIdDetection&&this.saved&&this.oldId==this.doc._id){let{_id:o,...r}=this.doc;this.doc=r,console.warn(`The _id ${o} has already been saved once, overriding it with a new id!`)}let e=await this.collection.insertOne(this.doc);if(!e.insertedId)throw Error("Not inserted");if(!s.opts.noDocsUpdate){let o=await this.collection.findOne({_id:e.insertedId});if(!o)throw Error("Weird");this.doc=o}return this.saved=!0,this.oldId=e.insertedId,this.doc}static async find(e){return await this.collection.find(e).toArray()}static async findOne(e){return await this.collection.findOne(e)}static async findOneAndDelete(e){let o=await this.collection.findOneAndDelete(e);if(!o.ok)throw new Error("findOneAndDelete returned not OK");return o.value}static async findOneAndReplace(e,o){let r=this.schema.validate(o);if(!r.valid)throw new u(r);o=r.res;let n=await this.collection.findOneAndReplace(e,o);if(!n.ok)throw new Error("findOneAndReplace returned not OK");return n.value}static async findOneAndUpdate(e,o){let r=this.schema.validate(o,{ignoreDefault:!0,ignoreRequired:!0});if(!r.valid)throw new u(r);let n=await this.collection.findOneAndUpdate(e,{$set:o});if(!n.ok)throw new Error("findOneAndUpdate returned not OK");return n.value}static async deleteMany(e){await this.collection.deleteMany(e)}};function w(l,e,o){class r extends g{constructor(i={}){super(l,e,i,o)}}let n=setInterval(function(){s.on&&(clearInterval(n),r.collection=s.db.collection(l))},100);return r.schema=e,r.methods=o,r}export{y as MongoSteel,f as Schema,w as model,h as toUrl};
